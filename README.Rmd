---
title: "Analysis of Water Temperatures"
subtitle: "A Collaboration with STINAPA"
author: "Tadge McWilliams"
date: "May 19th, 2023"
output: 
  html_document:
    toc: TRUE
    toc_float:
      collapsed: FALSE
---

```{r loading packages, include=FALSE, echo=FALSE}
library(readxl)
library(tidyverse)
library(lubridate)
library(pander)
library(flextable)
library(rempsyc)
```

```{r loading data, echo=FALSE}
setwd("~/Documents/Data Science/STINAPA/Temp & Light Project")
tl2020 <- read_excel("2020 raw.xlsx", sheet = 1)
tl2021 <- read_excel("2021 raw.xlsx", sheet = 1)
tl2022 <- read_excel("2022 raw.xlsx", sheet = 1)
```


## Summary
...summary of data, analysis, methods, and findings.

## Data Collected
...highlevel overview of the data collected.  Quantity, sites, depths, locations, missing data.

## Methodology
...how was data handeled. what formuli were used.  what past work was used

## Outliers

Outliers play an important part in this data set.  Statistically, outliers are observations that fall beyond the upper and lower quartiles by at least 1.5 times the interquartile range. While outliers can represent collection errors, they can also represent real environmental anomalies that lead to new discoveries or help to explain a greater trend in the data.  For these reasons, I have used a conservative approach in handling outliers.

For this data set, I chose to include all observations below the first quartile.  My reasoning is as follows: First, it is reasonable to assume that abnormally low temperature readings are legitimate.  Given Bonaire's hot climate, unnatural readings are difficult to produce unless the sensor malfunctions or the sensor is placed in an artificially cooled environment.  Second, upwellings of colder water have been recorded in the past, and these upwellings can have a significant effect on the environment.  Thus, their presence is an important feature for study.

Outliers above the third quartile were carefully considered.  In reviewing the data, it is clear that some temperature readings are impossible ocean temperatures.  There is also a plausible scenario in which the data sensors continued to record temperatures when they were brought above water, likely laying on a boat in direct sun during cleaning and data retrieval.  I concluded that the impossible values should be removed from the dataset so as to yield a more accurate analysis, but choosing a threshold for unnatural observations was challenging.  Initially, I calculated the the threshold using that standard statistical outlier method (Q3 + 1.5 x IQR) for each year; however, a significant number of observations fall along that temperature.  After consulting Erik Meesters, Tropical Marine Ecologist and Bio Statistician at Wageningen Marine Research, I agreed with his suggestion that any observations above 33 degrees celsius were not recorded in the water[^1].  The visualizations below help to confirm that while a 33 degree threshold is somewhat arbitrary, this higher threshold includes potentially natural outliers while excluding the majority of observations that are truly impossible.  This method could be deemed overly conservative or simplistic, but as Erik aptly suggested, it would be prudent not to omit any observations unless you are 100% sure  the reading is wrong.

[^1]: E. Meesters, personal communication, March 16th, 2023.

```{r 2020 outliers, echo=FALSE}
ggplot(tl2020, aes(temp_c)) +
  geom_bar() + 
  facet_wrap(~depth_m) +
  ggtitle("2020 Distribution by Depth")

quant2020 <- quantile(tl2020$temp_c, probs = c(0.25, 0.75))
statoutlier2020 <- (IQR(tl2020$temp_c) * 1.5) + quant2020[2]

ggplot(tl2020, aes(x=factor(month(date)), y = temp_c)) + 
    stat_boxplot(geom ='errorbar', width = 0.2) + 
    geom_boxplot() +
    xlab("Month") + 
    ylab("Water Temperature (c)") +
    ggtitle("2020 Data") +
    geom_hline(yintercept = 33, col = "red") + 
      annotate("text", x = 8, y = 20, hjust = "left", label = "- 33 Degrees", col = "red") +
    geom_hline(yintercept = statoutlier2020, col = "blue") +
      annotate("text", x = 8, y = 17, hjust = "left", label = "- Statistical Outlier", col = "blue")
```


```{r 2021 outliers, echo=FALSE}
ggplot(tl2021, aes(temp_c)) +
  geom_bar() + 
  facet_wrap(~depth_m) +
  ggtitle("2021 Distribution by Depth")

quant2021 <- quantile(tl2021$temp_c, probs = c(0.25, 0.75))
statoutlier2021 <- (IQR(tl2021$temp_c) * 1.5) + quant2021[2]

ggplot(tl2021, aes(x=factor(month(date)), y = temp_c)) + 
    stat_boxplot(geom ='errorbar', width = 0.2) + 
    geom_boxplot() +
    xlab("Month") + 
    ylab("Water Temperature (c)") +
    ggtitle("2021 Data") +
    geom_hline(yintercept = 33, col = "red") + 
      annotate("text", x = 8, y = 20, hjust = "left", label = "- 33 Degrees", col = "red") +
    geom_hline(yintercept = statoutlier2021, col = "blue") +
      annotate("text", x = 8, y = 17, hjust = "left", label = "- Statistical Outlier", col = "blue")
```


```{r 2022 outliers, echo=FALSE}
ggplot(tl2022, aes(temp_c)) +
  geom_bar() + 
  facet_wrap(~depth_m) +
  ggtitle("2022 Distribution by Depth")

quant2022 <- quantile(tl2022$temp_c, probs = c(0.25, 0.75))
statoutlier2022 <- (IQR(tl2022$temp_c) * 1.5) + quant2022[2]

ggplot(tl2022, aes(x=factor(month(date)), y = temp_c)) + 
    stat_boxplot(geom ='errorbar', width = 0.2) + 
    geom_boxplot() +
    xlab("Month") + 
    ylab("Water Temperature (c)") +
    ggtitle("2022 Data") +
    geom_hline(yintercept = 33, col = "red") + 
      annotate("text", x = 8, y = 20, hjust = "left", label = "- 33 Degrees", col = "red") +
    geom_hline(yintercept = statoutlier2022, col = "blue") +
      annotate("text", x = 8, y = 18, hjust = "left", label = "- Statistical Outlier", col = "blue")
```

```{r removing outliers above 33 degrees, echo=FALSE}
tl2020_33 <- tl2020 %>% filter(temp_c <= 33)
tl2021_33 <- tl2021 %>% filter(temp_c <= 33)
tl2022_33 <- tl2022 %>% filter(temp_c <= 33)
```


## Data Analysis

```{r formatting date and time columns, echo=FALSE}
tl2020_33$date <- as.Date(tl2020_33$date)
tl2020_33$time <- strftime(tl2020_33$time, format="%H:%M:%S")

tl2021_33$date <- as.Date(tl2021_33$date)
tl2021_33$time <- strftime(tl2021_33$time, format="%H:%M:%S")

tl2022_33$date <- as.Date(tl2022_33$date)
tl2022_33$time <- strftime(tl2022_33$time, format="%H:%M:%S")
```
The average water temperature in 2022 was generally higher than in 2020 or 2021.  The water temperature in January 2022 appears to be quite low; however, it is likely this average is being skewed by isolated low temperature outliers. 

```{r average water temp by month, echo=FALSE}
#2020
avg_temp20 <- tl2020_33 %>%
  mutate(month = month(date)) %>% 
  group_by(month) %>%
  summarize(avg_temp20 = mean(temp_c))
#2021 
avg_temp21 <- tl2021_33 %>%
  mutate(month = month(date)) %>% 
  group_by(month) %>%
  summarize(avg_temp21 = mean(temp_c))
#2022
avg_temp22 <- tl2022_33 %>%
  mutate(month = month(date)) %>% 
  group_by(month) %>%
  summarize(avg_temp22 = mean(temp_c))
#Joining years
avg_temps <- avg_temp20 %>% 
  full_join(avg_temp21, by = "month") %>%
  full_join(avg_temp22, by = "month") %>%
  arrange(month)

avg_temps %>% 
  pivot_longer(cols = avg_temp20:avg_temp22, names_to = "year", values_to = "temp") %>% 
  ggplot(aes(month,  temp, color = year)) +
    geom_line() +
    scale_color_manual(name = "Year", 
                       labels = c("2020", "2021", "2022"),
                       values = c("deepskyblue1","darkviolet","darkblue"),
                       guide = guide_legend(reverse = TRUE)) +
    scale_x_continuous(breaks = 1:12, "Month") + 
    scale_y_continuous(limits = c(23, 31), breaks = seq(23, 31, 1), "Water Temperature (c)") + 
    ggtitle("Average Water Temperature") 

avg_temps %>% rename("Month" = month,
                     "2020" = avg_temp20,
                     "2021" = avg_temp21,
                     "2022" = avg_temp22) %>%
  nice_table(title = "Average Water Temperature (c)") %>%
  colformat_double(j = c(1), digits = 0, na_str = "N/A")

```


